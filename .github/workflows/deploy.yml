name: Deploy NPS Reports Creator

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      period_start:
        description: 'Start period (YYYY-MM-DD)'
        required: false
        default: ''
      period_end:
        description: 'End period (YYYY-MM-DD)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t npsreportscreator:latest .

      - name: Save Docker image
        run: |
          docker save npsreportscreator:latest | gzip > npsreportscreator.tar.gz

      - name: Create directory on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            mkdir -p /opt/nps_reports_creator
            chmod 755 /opt/nps_reports_creator

      - name: Copy Docker image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "npsreportscreator.tar.gz"
          target: "/opt/nps_reports_creator/"
          strip_components: 0

      - name: Copy requirements to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "requirements.txt"
          target: "/opt/nps_reports_creator/"
          strip_components: 0

      - name: Copy other necessary files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "Dockerfile,.dockerignore,docker-compose.yml"
          target: "/opt/nps_reports_creator/"
          strip_components: 0

      - name: Deploy and setup on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /opt/nps_reports_creator
            
            # Определяем период для запуска
            PERIOD_START="${{ github.event.inputs.period_start }}"
            PERIOD_END="${{ github.event.inputs.period_end }}"
            
            # Если период не указан в ручном запуске, берем из secrets или используем значения по умолчанию
            if [ -z "$PERIOD_START" ]; then
              PERIOD_START="${{ secrets.PERIOD_START || '2025-11-01' }}"
            fi
            
            if [ -z "$PERIOD_END" ]; then
              PERIOD_END="${{ secrets.PERIOD_END || '2025-11-15' }}"
            fi
            
            # Создаем .env файл
            cat > .env << EOF
            # Настройки базы данных
            NPS_DB_HOST=${{ secrets.NPS_DB_HOST || '127.0.0.1' }}
            NPS_DB_PORT=${{ secrets.NPS_DB_PORT || '5432' }}
            NPS_DB_NAME=${{ secrets.NPS_DB_NAME || 'nps' }}
            NPS_DB_USER=${{ secrets.NPS_DB_USER || 'postgres' }}
            NPS_DB_PASSWORD=${{ secrets.NPS_DB_PASSWORD || 'por_pas_123' }}
            
            # Настройки OpenAI/LiteLLM
            LLM_KEY=${{ secrets.LLM_KEY }}
            MODEL_NAME=${{ secrets.MODEL_NAME || 'openai-gpt-5' }}
            LITELLM_BASE_URL=${{ secrets.LITELLM_BASE_URL || 'https://litellm.poryadok.ru' }}
            
            # Настройки приложения
            OUTPUT_DIR=${{ secrets.OUTPUT_DIR || 'output' }}
            PERIOD_START=$PERIOD_START
            PERIOD_END=$PERIOD_END
            
            # Логирование
            PORADOCK_LOG_TOKEN=${{ secrets.PORADOCK_LOG_TOKEN }}
            BITRIX_NPS_REPORTS_FOLDER_ID=${{ secrets.BITRIX_NPS_REPORTS_FOLDER_ID || '4850012' }}
            BITRIX_TOKEN=${{ secrets.BITRIX_TOKEN }}
            BITRIX_USER_ID=${{ secrets.BITRIX_USER_ID || '163472' }}
            EOF
            
            # Загружаем Docker образ
            docker load < npsreportscreator.tar.gz
            
            # Останавливаем старые контейнеры с таким именем
            echo "Stopping and removing old containers..."
            docker stop NPSReportsCreator 2>/dev/null || true
            docker rm NPSReportsCreator 2>/dev/null || true
            
            # Удаляем старые контейнеры с именем my-app (если существуют)
            docker stop my-app 2>/dev/null || true
            docker rm my-app 2>/dev/null || true
            
            # Запускаем новый контейнер для разового выполнения
            echo "Starting container with period: $PERIOD_START to $PERIOD_END"
            docker run -d \
              --name NPSReportsCreator \
              --env-file .env \
              npsreportscreator:latest
            
            # Ждем запуска контейнера
            sleep 10
            
            # Проверяем что контейнер работает
            if ! docker ps | grep -q NPSReportsCreator; then
              echo "ERROR: Container is not running"
              docker logs NPSReportsCreator --tail 50 2>/dev/null || echo "Cannot get logs"
              exit 1
            fi
            
            # Показываем логи для мониторинга выполнения
            echo "Container logs (last 30 lines):"
            docker logs NPSReportsCreator --tail 30
            
            # Проверяем завершился ли контейнер успешно (если это разовая задача)
            CONTAINER_STATUS=$(docker inspect NPSReportsCreator --format='{{.State.Status}}')
            echo "Container status: $CONTAINER_STATUS"
            
            if [ "$CONTAINER_STATUS" = "exited" ]; then
              EXIT_CODE=$(docker inspect NPSReportsCreator --format='{{.State.ExitCode}}')
              if [ "$EXIT_CODE" -eq 0 ]; then
                echo "Container completed successfully with exit code: $EXIT_CODE"
              else
                echo "ERROR: Container exited with code: $EXIT_CODE"
                docker logs NPSReportsCreator --tail 100
                exit 1
              fi
            fi
            
            # Настраиваем cron задание для регулярного запуска
            echo "Setting up cron job..."
            
            # Создаем скрипт для cron
            cat > /opt/nps_reports_creator/run_nps_report.sh << 'SCRIPT_EOF'
            #!/bin/bash
            
            # Директория приложения
            cd /opt/nps_reports_creator
            
            # Определяем период (например, предыдущий месяц)
            # Можно настроить логику расчета периода
            CURRENT_DATE=$(date +%Y-%m-%d)
            LAST_MONTH_START=$(date -d "$CURRENT_DATE -1 month" +%Y-%m-01)
            LAST_MONTH_END=$(date -d "$LAST_MONTH_START +1 month -1 day" +%Y-%m-%d)
            
            # Останавливаем и удаляем старый контейнер если он есть
            docker stop NPSReportsCreator_$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
            docker rm NPSReportsCreator_$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
            
            # Запускаем новый контейнер с периодом
            docker run \
              --name NPSReportsCreator_$(date +%Y%m%d_%H%M%S) \
              --env-file .env \
              -e PERIOD_START=$LAST_MONTH_START \
              -e PERIOD_END=$LAST_MONTH_END \
              --rm \
              npsreportscreator:latest
            
            # Логируем запуск
            echo "[$(date)] NPS report generated for period: $LAST_MONTH_START to $LAST_MONTH_END" >> /var/log/nps_reports.log
            SCRIPT_EOF
            
            # Даем права на выполнение
            chmod +x /opt/nps_reports_creator/run_nps_report.sh
            
            
           
            (crontab -l 2>/dev/null | grep -v "run_nps_report.sh") | crontab -
            
            
            (crontab -l 2>/dev/null; echo "0 3 1 * * /opt/nps_reports_creator/run_nps_report.sh >> /var/log/nps_reports_cron.log 2>&1") | crontab -
            (crontab -l 2>/dev/null; echo "# TEST: Run every 5 minutes - comment out in production") | crontab -
            (crontab -l 2>/dev/null; echo "# */5 * * * * /opt/nps_reports_creator/run_nps_report.sh >> /var/log/nps_reports_test.log 2>&1") | crontab -
            
            echo "Cron jobs installed:"
            crontab -l
            
            
            echo "Cleaning up old Docker images..."
            docker images npsreportscreator --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi 2>/dev/null || true
            
            
            rm -f npsreportscreator.tar.gz
            
            echo "Deployment and cron setup successful!"

      - name: Cleanup local files
        if: always()
        run: |
          rm -f npsreportscreator.tar.gz