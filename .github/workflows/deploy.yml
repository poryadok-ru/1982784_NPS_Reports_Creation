name: Deploy NPS Reports Creator
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      period_start:
        description: 'Start period (YYYY-MM-DD, optional)'
        required: false
        default: ''
      period_end:
        description: 'End period (YYYY-MM-DD, optional)'
        required: false
        default: ''
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t npsreportscreator:latest .

      - name: Save Docker image
        run: docker save npsreportscreator:latest | gzip > npsreportscreator.tar.gz

      - name: Create directory on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            mkdir -p /opt/nps_reports_creator
            chmod 755 /opt/nps_reports_creator

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "npsreportscreator.tar.gz,requirements.txt,Dockerfile"
          target: "/opt/nps_reports_creator"
          strip_components: 0

      - name: Deploy and setup on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /opt/nps_reports_creator
            PERIOD_START="${{ github.event.inputs.period_start }}"
            PERIOD_END="${{ github.event.inputs.period_end }}"
            if [ -z "$PERIOD_START" ]; then
              PERIOD_START="${{ secrets.PERIOD_START || '' }}"
            fi
            if [ -z "$PERIOD_END" ]; then
              PERIOD_END="${{ secrets.PERIOD_END || '' }}"
            fi
            # Если периоды все еще не заданы, используем значения по умолчанию (с 1 числа месяца по вчерашний день)
            if [ -z "$PERIOD_START" ]; then
              PERIOD_START=$(date +%Y-%m-01)
            fi
            if [ -z "$PERIOD_END" ]; then
              # Пробуем разные варианты команды date для совместимости
              PERIOD_END=$(date -d "yesterday" +%Y-%m-%d 2>/dev/null || date -d "1 day ago" +%Y-%m-%d 2>/dev/null || date -v-1d +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
            fi
            echo "Using period: $PERIOD_START to $PERIOD_END"
            # Создаем .env файл
            cat > .env << EOF
            NPS_DB_HOST=${{ secrets.NPS_DB_HOST || '127.0.0.1' }}
            NPS_DB_PORT=${{ secrets.NPS_DB_PORT || '5432' }}
            NPS_DB_NAME=${{ secrets.NPS_DB_NAME || 'nps' }}
            NPS_DB_USER=${{ secrets.NPS_DB_USER || 'postgres' }}
            NPS_DB_PASSWORD=${{ secrets.NPS_DB_PASSWORD || 'por_pas_123' }}
            LLM_KEY=${{ secrets.LLM_KEY }}
            MODEL_NAME=${{ secrets.MODEL_NAME || 'openai-gpt-5' }}
            LITELLM_BASE_URL=${{ secrets.LITELLM_BASE_URL || 'https://litellm.poryadok.ru' }}
            OUTPUT_DIR=${{ secrets.OUTPUT_DIR || 'output' }}
            PERIOD_START=$PERIOD_START
            PERIOD_END=$PERIOD_END
            PORADOCK_LOG_TOKEN=${{ secrets.PORADOCK_LOG_TOKEN }}
            BITRIX_NPS_REPORTS_FOLDER_ID=${{ secrets.BITRIX_NPS_REPORTS_FOLDER_ID || '4850012' }}
            BITRIX_TOKEN=${{ secrets.BITRIX_TOKEN }}
            BITRIX_USER_ID=${{ secrets.BITRIX_USER_ID || '163472' }}
            EOF

            docker load < npsreportscreator.tar.gz
            docker stop NPSReportsCreator 2>/dev/null || true
            docker rm NPSReportsCreator 2>/dev/null || true
            docker stop my-app 2>/dev/null || true
            docker rm my-app 2>/dev/null || true
            echo "Starting container with period: $PERIOD_START to $PERIOD_END"
            
            CONTAINER_ID=$(docker run -d --name NPSReportsCreator --network host --env-file .env npsreportscreator:latest)
            echo "Container started with ID: $CONTAINER_ID"
            
            # Ждем немного и проверяем статус
            sleep 5
            
            # Check container status
            CONTAINER_STATUS=$(docker inspect NPSReportsCreator --format='{{.State.Status}}' 2>/dev/null || echo "not_found")
            echo "Container status after 5s: $CONTAINER_STATUS"
            
            if [ "$CONTAINER_STATUS" = "not_found" ]; then
              echo "ERROR: Container not found"
              exit 1
            fi
            
            # Показываем логи сразу
            echo "=== Container logs (all) ==="
            docker logs NPSReportsCreator 2>&1 || echo "Cannot get logs"
            echo "=== End of logs ==="
            
            # Ждем еще немного для завершения
            sleep 5
            
            # Проверяем финальный статус
            CONTAINER_STATUS=$(docker inspect NPSReportsCreator --format='{{.State.Status}}' 2>/dev/null || echo "not_found")
            EXIT_CODE=$(docker inspect NPSReportsCreator --format='{{.State.ExitCode}}' 2>/dev/null || echo "unknown")
            
            echo "Final container status: $CONTAINER_STATUS"
            echo "Container exit code: $EXIT_CODE"
            
            if [ "$CONTAINER_STATUS" = "exited" ]; then
              if [ "$EXIT_CODE" -eq 0 ]; then
                echo "Container completed successfully with exit code: $EXIT_CODE"
                echo "This is normal for one-time tasks. Container finished its work."
              else
                echo "ERROR: Container exited with code: $EXIT_CODE"
                echo "=== Full container logs (retry) ==="
                docker logs NPSReportsCreator 2>&1 || echo "Cannot get logs"
                echo "=== Container inspect info ==="
                docker inspect NPSReportsCreator --format='{{json .State}}' 2>/dev/null || echo "Cannot inspect"
                exit 1
              fi
            elif [ "$CONTAINER_STATUS" = "running" ]; then
              echo "Container is still running"
            else
              echo "WARNING: Container status is: $CONTAINER_STATUS"
              docker logs NPSReportsCreator 2>&1 || echo "Cannot get logs"
            fi
            
            echo "Setting up cron job..."
            cat > run_nps_report.sh << 'SCRIPT_EOF'
            #!/bin/bash
            cd /opt/nps_reports_creator
            
            # Определяем даты: с 1 числа месяца по вчерашний день
            PERIOD_START=$(date +%Y-%m-01)
            PERIOD_END=$(date -d "yesterday" +%Y-%m-%d)

            # Удаляем старый контейнер, если вдруг "завис"
            docker rm -f NPSReportsCreator_cron 2>/dev/null || true
            # Передаём даты как переменные окружения в контейнер
            docker run --name NPSReportsCreator_cron --network host --env-file .env \
              -e PERIOD_START=$PERIOD_START \
              -e PERIOD_END=$PERIOD_END \
              --rm \
              npsreportscreator:latest
            echo "[$(date)] NPS report generated for period: $PERIOD_START to $PERIOD_END" >> /opt/nps_reports_creator/nps_reports.log
            SCRIPT_EOF
            chmod +x run_nps_report.sh

            (crontab -l 2>/dev/null | grep -v "run_nps_report.sh") | crontab -
            (crontab -l 2>/dev/null; echo "0 3 1 * * /opt/nps_reports_creator/run_nps_report.sh >> /opt/nps_reports_creator/nps_reports_cron.log 2>&1") | crontab -
            # тестовый запуск каждые 5 минут — УДАЛИТЕ/ЗАКОММЕНТИРУЙТЕ В ПРОДАКШНЕ!
            #(crontab -l 2>/dev/null; echo "*/5 * * * * /opt/nps_reports_creator/run_nps_report.sh >> /opt/nps_reports_creator/nps_reports_test.log 2>&1") | crontab -

            echo "Cron jobs installed:"
            crontab -l

            echo "Cleaning up old Docker images..."
            docker images npsreportscreator --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi 2>/dev/null || true
            rm -f npsreportscreator.tar.gz
            echo "Deployment and cron setup successful!"

      - name: Cleanup local files
        if: always()
        run: rm -f npsreportscreator.tar.gz